#!/usr/bin/env bash

set -e -u -o pipefail

main() (
  outdir=$1; shift

  for input; do
    output=${input%.tex}.svg
    output=${outdir%/}/${output#tex/}
    tmp=/tmp/$(basename "${input%.tex}.pdf")
    make-svg
  done
)

make-svg() (
  ( set -x; pdflatex -halt-on-error -output-directory /tmp "$input" ) |
  (
    if [[ ${TEX_LOG-} ]]; then
      cat
    else
      cat >/dev/null
    fi
  )
  pdf=${input#*/}
  pdf=/tmp/${pdf%.tex}.pdf
  set -x
  pdf2svg "$pdf" tmp.svg
  mv tmp.svg "$output"
)

main "$@"
