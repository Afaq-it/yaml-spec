#!/usr/bin/env bash

set -e -u -o pipefail

main() (
  outdir=$1; shift

  for input; do
    output=${input%.tex}.png
    output=${outdir%/}/${output#tex/}
    tmp=/tmp/$(basename "${input%.tex}.pdf")
    make-png
  done
)

make-png() (
  ( set -x; pdflatex -halt-on-error -output-directory /tmp "$input" ) |
  (
    if [[ ${TEX_LOG-} ]]; then
      cat
    else
      cat >/dev/null
    fi
  )
  set -x
  pdftoppm -png -singlefile -r 750 "$tmp" tmp
  mv tmp.png "$output"
)

main "$@"
